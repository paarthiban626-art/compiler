<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parthiban Compiler</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    
    <!-- AlaSQL for Client-Side SQL -->
    <script src="https://cdn.jsdelivr.net/npm/alasql@4.0.0/dist/alasql.min.js"></script>

    <!-- Additional CodeMirror Modes for HTML Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        /* CodeMirror Customization */
        .CodeMirror {
            height: 100%;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table Styles for SQL Output */
        .sql-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .sql-table th, .sql-table td {
            border: 1px solid #4b5563;
            padding: 8px;
            text-align: left;
        }
        .sql-table th {
            background-color: #374151;
            color: #e5e7eb;
        }
        .sql-table tr:nth-child(even) {
            background-color: #252a33;
        }
        .sql-table tr:hover {
            background-color: #374151;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col overflow-hidden font-sans">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 min-h-[3.5rem] py-2 flex flex-wrap items-center justify-between px-3 gap-2 shrink-0 shadow-md z-10">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-code text-blue-500 text-xl"></i>
            <h1 class="text-lg font-bold tracking-wide text-white"><span class="text-blue-400">Parthiban</span> <span class="hidden sm:inline">Compiler</span></h1>
        </div>

        <div class="flex items-center gap-2 flex-wrap justify-end flex-1">
            <!-- Language Buttons (Header Style) -->
            <div class="flex bg-gray-700 rounded-md p-1 gap-1" id="langTabs">
                <button data-lang="cpp" class="lang-btn px-2 py-1.5 text-xs sm:text-sm rounded font-medium transition-all bg-blue-600 text-white shadow-sm">C++</button>
                <button data-lang="sql" class="lang-btn px-2 py-1.5 text-xs sm:text-sm rounded font-medium transition-all text-gray-400 hover:text-gray-200 hover:bg-gray-600">MySQL</button>
                <button data-lang="html" class="lang-btn px-2 py-1.5 text-xs sm:text-sm rounded font-medium transition-all text-gray-400 hover:text-gray-200 hover:bg-gray-600">HTML</button>
            </div>

            <div class="flex items-center gap-2 pl-1 border-l border-gray-600 ml-1">
                <button id="runBtn" class="bg-green-600 hover:bg-green-700 text-white text-xs sm:text-sm font-semibold py-1.5 px-3 rounded flex items-center gap-2 transition-all shadow-lg active:scale-95 whitespace-nowrap">
                    <i class="fa-solid fa-play text-xs"></i> <span>Run</span>
                </button>

                <button id="newTabBtn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs sm:text-sm font-semibold py-1.5 px-3 rounded flex items-center gap-2 transition-all whitespace-nowrap" title="Open Output in New Tab">
                    <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i> <span>New Tab</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Editor Section -->
        <div class="flex-1 flex flex-col border-b md:border-b-0 md:border-r border-gray-700 min-h-[50%] md:min-h-0 relative">
            <div class="bg-gray-800 text-xs text-gray-400 px-3 py-1 flex justify-between items-center select-none">
                <span><i class="fa-regular fa-file-code mr-1"></i> source_code</span>
                <span class="text-[10px] opacity-70 hidden sm:inline">Ctrl+Enter to Run</span>
            </div>
            <!-- CodeMirror Container -->
            <div id="editor-container" class="flex-1 overflow-hidden"></div>
            
            <!-- Clear Code Button Overlay -->
            <button id="clearBtn" class="absolute bottom-4 right-6 bg-gray-700/80 hover:bg-gray-600 text-gray-300 p-2 rounded-full shadow-lg backdrop-blur-sm transition-all z-10" title="Reset Code">
                <i class="fa-solid fa-rotate-right text-sm"></i>
            </button>
        </div>

        <!-- IO Section (Right Side) -->
        <div class="w-full md:w-[40%] flex flex-col h-full bg-[#1e1e1e]">
            
            <!-- Input Area (Only for C++) -->
            <div id="inputSection" class="flex flex-col h-1/3 border-b border-gray-700 transition-all duration-300">
                <div class="bg-gray-800 text-xs text-gray-400 px-3 py-1 flex justify-between items-center">
                    <span><i class="fa-regular fa-keyboard mr-1"></i> Input (stdin)</span>
                </div>
                <textarea id="inputBox" class="flex-1 bg-[#1e1e1e] text-gray-300 p-3 resize-none focus:outline-none font-mono text-sm" placeholder="Enter program input here..."></textarea>
            </div>

            <!-- Output Area -->
            <div id="outputSection" class="flex flex-col flex-1 min-h-0">
                <div class="bg-gray-800 text-xs text-gray-400 px-3 py-1 flex justify-between items-center">
                    <span><i class="fa-solid fa-terminal mr-1"></i> Output</span>
                    <button id="copyBtn" class="hover:text-white transition-colors"><i class="fa-regular fa-copy"></i></button>
                </div>
                <div id="outputBox" class="flex-1 bg-[#1e1e1e] p-3 overflow-auto font-mono text-sm whitespace-pre-wrap text-gray-300 relative">
                    <div id="placeholderText" class="text-gray-600 italic">Click 'Run' to see output...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- CodeMirror Core & Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>

    <script>
        // --- Constants & Defaults ---
        const DEFAULT_CPP = `#include <iostream>
#include <string>
#include <vector>
#include <algorithm>

using namespace std;

int main() {
    string name;
    cout << "Enter your name: ";
    
    // Reads from Input box
    if (cin >> name) {
        cout << "Hello, " << name << "!" << endl;
    } else {
        cout << "Hello, World!" << endl;
    }

    vector<int> nums = {5, 2, 9, 1, 5};
    sort(nums.begin(), nums.end());
    
    cout << "Sorted numbers: ";
    for(int n : nums) cout << n << " ";
    cout << endl;

    return 0;
}`;

        const DEFAULT_SQL = `-- Create a table
CREATE TABLE Users (
    id INT PRIMARY KEY,
    name STRING,
    role STRING
);

-- Insert data
INSERT INTO Users VALUES (1, 'Parthiban', 'Admin');
INSERT INTO Users VALUES (2, 'Alice', 'Developer');
INSERT INTO Users VALUES (3, 'Bob', 'Designer');

-- Query data
SELECT * FROM Users;

-- Update data
UPDATE Users SET role = 'Lead Dev' WHERE name = 'Alice';

-- Final Query
SELECT * FROM Users WHERE role LIKE '%Dev%';`;

        const DEFAULT_HTML = `<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: sans-serif; text-align: center; color: #333; padding: 20px; }
        h1 { color: #3b82f6; }
        .card { background: #f3f4f6; padding: 20px; border-radius: 8px; display: inline-block; }
        button { padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #059669; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Hello HTML!</h1>
        <p>This is a live preview.</p>
        <button onclick="alert('It works!')">Click Me</button>
    </div>
</body>
</html>`;

        // --- DOM Elements ---
        const runBtn = document.getElementById('runBtn');
        const newTabBtn = document.getElementById('newTabBtn');
        const clearBtn = document.getElementById('clearBtn');
        const copyBtn = document.getElementById('copyBtn');
        const inputSection = document.getElementById('inputSection');
        const inputBox = document.getElementById('inputBox');
        const outputBox = document.getElementById('outputBox');
        const placeholderText = document.getElementById('placeholderText');
        const langBtns = document.querySelectorAll('.lang-btn');

        // --- State Management ---
        let currentLang = 'cpp';
        let editor = null;

        // --- Initialization ---
        function init() {
            // Initialize CodeMirror
            editor = CodeMirror(document.getElementById('editor-container'), {
                lineNumbers: true,
                mode: 'text/x-c++src',
                theme: 'dracula',
                autoCloseBrackets: true,
                styleActiveLine: true,
                tabSize: 4,
                indentUnit: 4,
                indentWithTabs: true,
                lineWrapping: true
            });

            // Load saved state or defaults
            loadState();

            // Event Listeners
            langBtns.forEach(btn => {
                btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
            });

            runBtn.addEventListener('click', runCode);
            newTabBtn.addEventListener('click', openInNewTab);
            clearBtn.addEventListener('click', resetCode);
            copyBtn.addEventListener('click', copyOutput);
            
            // Keyboard Shortcut (Ctrl+Enter)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    runCode();
                }
            });

            // Auto-save on change
            editor.on('change', () => {
                localStorage.setItem(`parthiban_code_${currentLang}`, editor.getValue());
            });
            inputBox.addEventListener('input', () => {
                localStorage.setItem('parthiban_input', inputBox.value);
            });
        }

        function loadState() {
            const savedLang = localStorage.getItem('parthiban_lang');
            if (savedLang && ['cpp', 'sql', 'html'].includes(savedLang)) {
                currentLang = savedLang;
            } else {
                currentLang = 'cpp';
            }

            const savedInput = localStorage.getItem('parthiban_input');
            if (savedInput) inputBox.value = savedInput;

            updateUIForLang(currentLang);
            
            const savedCode = localStorage.getItem(`parthiban_code_${currentLang}`);
            if (savedCode) {
                editor.setValue(savedCode);
            } else {
                resetCode();
            }
        }

        function switchLanguage(lang) {
            if (currentLang === lang) return;
            currentLang = lang;
            localStorage.setItem('parthiban_lang', currentLang);
            
            updateUIForLang(lang);
            
            // Load code for new language
            const savedCode = localStorage.getItem(`parthiban_code_${currentLang}`);
            if (savedCode) {
                editor.setValue(savedCode);
            } else {
                resetCode();
            }
            
            // Clear output when switching
            outputBox.innerHTML = '';
            outputBox.appendChild(placeholderText);
            placeholderText.style.display = 'block';
        }

        function updateUIForLang(lang) {
            // Update Buttons
            langBtns.forEach(btn => {
                if (btn.dataset.lang === lang) {
                    btn.classList.remove('text-gray-400', 'hover:text-gray-200', 'hover:bg-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-sm');
                } else {
                    btn.classList.add('text-gray-400', 'hover:text-gray-200', 'hover:bg-gray-600');
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-sm');
                }
            });

            // Update Editor Mode & Input Box
            if (lang === 'cpp') {
                editor.setOption('mode', 'text/x-c++src');
                inputSection.style.display = 'flex';
            } else if (lang === 'sql') {
                editor.setOption('mode', 'text/x-sql');
                inputSection.style.display = 'none';
            } else if (lang === 'html') {
                editor.setOption('mode', 'htmlmixed');
                inputSection.style.display = 'none';
            }
        }

        function resetCode() {
            if (currentLang === 'cpp') editor.setValue(DEFAULT_CPP);
            else if (currentLang === 'sql') editor.setValue(DEFAULT_SQL);
            else if (currentLang === 'html') editor.setValue(DEFAULT_HTML);
        }

        // --- Execution Logic ---

        async function runCode() {
            const code = editor.getValue();
            const input = inputBox.value;
            
            // UI Loading State
            setOutputLoading(true);
            
            if (currentLang === 'cpp') {
                await runCpp(code, input);
            } else if (currentLang === 'sql') {
                await runSql(code);
            } else if (currentLang === 'html') {
                runHtml(code);
            }
        }

        function runHtml(code) {
            // Slight delay to simulate processing and allow UI update
            setTimeout(() => {
                setOutputLoading(false);
                outputBox.innerHTML = ''; // Clear previous output
                
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.background = '#ffffff'; // White background for HTML
                iframe.style.borderRadius = '4px';
                
                outputBox.appendChild(iframe);
                
                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(code);
                doc.close();
            }, 500);
        }

        async function runCpp(code, input) {
            // Using Piston API for reliable C++ execution
            const url = "https://emkc.org/api/v2/piston/execute";
            const data = {
                language: "cpp",
                version: "10.2.0",
                files: [
                    {
                        name: "main.cpp",
                        content: code
                    }
                ],
                stdin: input
            };

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.run) {
                    let output = result.run.stdout;
                    let error = result.run.stderr;
                    
                    // Handle output
                    if (error) {
                         setOutputHtml(`<span class="text-red-400">${escapeHtml(error)}</span>\n${escapeHtml(output)}`);
                    } else {
                         setOutputHtml(`<span class="text-green-400 font-bold mb-2 block">✓ Execution Successful</span>${escapeHtml(output)}`);
                    }
                } else {
                    setOutputHtml(`<span class="text-red-500">Error: Could not connect to compiler service.</span>`);
                }

            } catch (err) {
                setOutputHtml(`<span class="text-red-500">Network Error: ${err.message}</span>`);
            }
        }

        async function runSql(code) {
            // Using AlaSQL for client-side SQL execution
            try {
                // Create a fresh database instance for each run to avoid conflicts
                // Or we can keep it persistent. Let's create a fresh one for "Compiler" feel.
                const dbId = 'parthiban_db_' + Date.now();
                alasql(`CREATE DATABASE ${dbId}`);
                alasql(`USE ${dbId}`);

                // Split by semicolon to handle multiple statements (basic implementation)
                // AlaSQL can handle multiple statements if passed correctly
                const result = alasql(code);
                
                // Format Result
                let html = '';
                
                // Handle single result or array of results
                const results = Array.isArray(result) ? result : [result];

                // If last result is data, show it. If it's just '1' (affected rows), show success.
                let hasData = false;

                results.forEach((res, index) => {
                    // Check if it's an array of objects (SELECT result)
                    if (Array.isArray(res) && res.length > 0) {
                        hasData = true;
                        html += generateTable(res);
                    } else if (Array.isArray(res) && res.length === 0) {
                         // Empty result set
                    }
                });

                if (!hasData) {
                    html += '<div class="text-green-400 font-mono mt-2">Commands executed successfully. No data returned.</div>';
                }

                setOutputHtml(html, true); // true = render as HTML
                
                // Cleanup (Optional, alasql in-memory cleans up on refresh)
                alasql(`DROP DATABASE ${dbId}`);

            } catch (err) {
                setOutputHtml(`<span class="text-red-400">SQL Error: ${err.message}</span>`, true);
            }
        }

        // --- Helpers ---

        function setOutputLoading(isLoading) {
            if (isLoading) {
                runBtn.innerHTML = `<div class="loader mr-2 border-t-white border-white/30 w-3 h-3"></div> Running...`;
                runBtn.disabled = true;
                outputBox.innerHTML = ''; 
                outputBox.appendChild(placeholderText);
                placeholderText.innerHTML = '<span class="text-blue-400">Compiling and executing...</span>';
                placeholderText.style.display = 'block';
            } else {
                runBtn.innerHTML = `<i class="fa-solid fa-play text-xs"></i> <span>Run</span>`;
                runBtn.disabled = false;
            }
        }

        function setOutputHtml(content, isHtml = true) {
            setOutputLoading(false); // Stop loading
            placeholderText.style.display = 'none';
            if (isHtml) {
                outputBox.innerHTML = content;
            } else {
                outputBox.innerText = content;
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function generateTable(data) {
            if (data.length === 0) return '';
            const columns = Object.keys(data[0]);
            
            let html = '<div class="overflow-x-auto mb-6"><table class="sql-table"><thead><tr>';
            columns.forEach(col => html += `<th>${col}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => html += `<td>${row[col]}</td>`);
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function openInNewTab() {
            const newWindow = window.open();
            if (!newWindow) {
                alert('Please allow popups to open the output.');
                return;
            }
            
            const outputContent = outputBox.innerHTML;
            const isHtml = currentLang === 'html';
            
            if (isHtml) {
                // For HTML, we just write the raw code to the new tab
                newWindow.document.write(editor.getValue());
                newWindow.document.close();
                return;
            }

            // For C++/SQL, we wrap the output
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Parthiban Compiler – Output</title>
                    <style>
                        body { background-color: #111827; color: #e5e7eb; font-family: 'Courier New', monospace; padding: 20px; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th, td { border: 1px solid #4b5563; padding: 10px; text-align: left; }
                        th { background-color: #374151; }
                        .header { border-bottom: 1px solid #374151; padding-bottom: 10px; margin-bottom: 20px; }
                        h1 { color: #60a5fa; font-size: 20px; margin: 0; }
                        .timestamp { color: #6b7280; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Parthiban Compiler Output</h1>
                        <span class="timestamp">Generated on ${new Date().toLocaleString()}</span>
                    </div>
                    <div>
                        ${outputContent}
                    </div>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        function copyOutput() {
            // For HTML iframe, we can't easily copy output text, so we check
            if (currentLang === 'html') {
                 alert("Copy not available for HTML preview.");
                 return;
            }

            const range = document.createRange();
            range.selectNode(outputBox);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            
            const originalIcon = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fa-solid fa-check text-green-400"></i>';
            setTimeout(() => copyBtn.innerHTML = originalIcon, 2000);
        }

        // Run Initialization
        window.onload = init;

    </script>
</body>
</html>